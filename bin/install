#!/bin/bash
# shellcheck disable=1012,2016

set -e

app_dir=$(realpath "$(dirname "${BASH_SOURCE[0]}")/../")
fmt_bold="\033[1m"
fmt_cyan="\033[36m"
fmt_green="\033[32m"
fmt_reset="\033[0m"
fmt_yellow="\033[33m"

function create_symlinks() {
  log_install_start "🔗 Symlinks"

  config_files=($(ls -a "${app_dir}/config/"))

  for file in "${config_files[@]}"; do
    if [[ ! $file =~ ^\.{1,2}$|\.sw.*$ ]]; then
      \rm -f "${HOME}/${file}"
      ln -s "${app_dir}/config/${file}" "${HOME}/${file}"
    fi
  done
}

function init_git_submodules() {
  log_install_start "🌿 Initializing Git Submodules"
  sh -c "cd ${app_dir} && git submodule update --init --recursive"
}

function install_apt_packages() {
  to_install=()

  for arg in "$@"; do
    if ! (dpkg -l | grep -v "^rc" | grep "$arg" | awk '{print $2}' | grep -q "^$arg\(:\w\+\)\?$"); then
      to_install+=("$arg")
    fi
  done

  [[ "${#to_install[*]}" = "0" ]] && return 0

  log_install_start "${to_install[*]}" && \
  sudo apt-get install -y "${to_install[@]}"

}

function install_pgformatter() {
  if [[ -n $(which pg_format) ]]; then
    return 0
  fi

  log_install_start "🐘😍 pgFormatter"

  version=5.5
  wget https://github.com/darold/pgFormatter/archive/refs/tags/v${version}.tar.gz
  tar xzf v${version}.tar.gz
  cd pgFormatter-${version}/ || exit
  perl Makefile.PL
  make && sudo make install
  cd ../ && \rm -rf v${version}.tar.gz && rm -rf pgFormatter-${version} #clean up
}

function install_pip3_packages() {
  to_install=()
  installed_packages=$(pip3 list --format=columns)

  for arg in "${@}"; do
    if ! (echo -e "${installed_packages}" | grep -q "^${arg}\b"); then
      log_install_start "🐍📦 Installing pip3 Package: ${arg}"
      pip3 install "${arg}"
    fi
  done
}


function log_install_start() {
  echo -e "${fmt_bold}${fmt_yellow}📦 Installing ${fmt_reset}${fmt_cyan}$1${fmt_reset}"
}

if [[ $OSTYPE =~ ^linux.* ]]; then
  packages=(
    "make"
    "python3"
    "python3-pip"
  )

  sudo apt-get update
  install_apt_packages "${packages[@]}"
fi

install_pgformatter
install_pip3_packages "pynvim"
init_git_submodules
create_symlinks

echo -e "${fmt_bold}${fmt_green}🎉 Successfully installed Dev Tools!${fmt_reset}"
