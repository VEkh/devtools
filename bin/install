#!/usr/bin/env bash
# shellcheck disable=1012,2016

set -e

app_dir=$(realpath "$(dirname "${BASH_SOURCE[0]}")/../")

# ASCII, install_apt_packages
# shellcheck disable=1090,1091
source "${app_dir}/config/.utils"

function configure_zsh() {
  [[ -z $(which zsh) ]] && return 0

  ascii_print "ğŸš Configuring zsh" "cyan"

  [[ ! "${SHELL}" =~ /zsh$ ]] && chsh -s "$(which zsh)"

  if [[ ! -d "${HOME}/.oh-my-zsh" ]]; then
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
  fi

  custom_plugins_dir="${ZSH_CUSTOM:-${HOME}/.oh-my-zsh/custom}/plugins"

  if [[ ! -d "${custom_plugins_dir}/zsh-autosuggestions" ]]; then
    git clone https://github.com/zsh-users/zsh-autosuggestions \
      "${custom_plugins_dir}/zsh-autosuggestions"
  fi
}

function create_symlinks() {
  log_install_start "ğŸ”— Symlinks"

  # shellcheck disable=2207
  config_files=($(ls -a "${app_dir}/config/"))

  for file in "${config_files[@]}"; do
    if [[ ! $file =~ ^\.{1,2}$|\.sw.*$ ]]; then
      \rm -rf "${HOME:?}/${file}"
      ln -s "${app_dir}/config/${file}" "${HOME}/${file}"
    fi
  done
}

function install_ai_tools() {
  if [[ -z "$(which claude)" ]]; then
    log_install_start "ğŸ¤– Claude AI"
    curl -fsSL https://claude.ai/install.sh | bash
  fi
}

function init_git_submodules() {
  log_install_start "ğŸŒ¿ Initializing Git Submodules"
  sh -c "cd ${app_dir} && git submodule update --init --recursive"
}

function install_mise() {
  [[ -n "$(which mise)" ]] && return 0

  log_install_start "ğŸ’» Mise"

  curl https://mise.run | sh

  ascii_print "ğŸ‰ Successfully installed mise!" "green"
  ascii_print "Follow the above shell rc (.bashrc, .zshrc, etc) edit instructions. Then:" "yellow"
  ascii_print "  1. Log out then log back in to your shell." "yellow"
  ascii_print "  2. Navigate back to this directory and continue installation." "yellow"
  exit 1
}

function install_mise_config() {
  if [[ -z "$(which mise)" ]]; then
    ascii_print "ğŸ›‘ Install mise before trying to install from its config." "red" >&2
    exit 1
  fi

  mise install
}

function install_mise_tool() {
  if [[ -z "$(which mise)" ]]; then
    ascii_print "ğŸ›‘ Install mise before trying to install from its config." "red" >&2
    exit 1
  fi

  mise install "${1}"
}

function install_node_global_packages() {
  if [[ -z "$(which npm)" ]]; then
    ascii_print "ğŸ›‘ Ensure npm is installed before proceeding." "red" >&2
    ascii_print "If you just installed \`nodejs\`. You may need to simply re-run this script." "yellow" >&2
    exit 1
  fi

  installed_packages=$(npm list --global)

  for arg in "${@}"; do
    if ! (echo -e "${installed_packages}" | grep -q "${arg}@"); then
      log_install_start "ğŸ“¦ Node Package: ${arg}"
      npm install --global "${arg}"
    fi
  done
}

function install_pgformatter() {
  [[ -n $(which pg_format) ]] && return 0

  log_install_start "ğŸ˜ğŸ˜ pgFormatter"

  version=5.5
  wget https://github.com/darold/pgFormatter/archive/refs/tags/v${version}.tar.gz
  tar xzf v${version}.tar.gz
  cd pgFormatter-${version}/ || exit
  perl Makefile.PL
  make && sudo make install
  cd ../ && \rm -rf v${version}.tar.gz && rm -rf pgFormatter-${version} #clean up
}

function install_pip3_packages() {
  installed_packages=$(pip3 list --format=columns)

  for arg in "${@}"; do
    if ! (echo -e "${installed_packages}" | grep -q "^${arg}\b"); then
      log_install_start "ğŸğŸ“¦ pip3 Package: ${arg}"
      pip3 install "${arg}"
    fi
  done
}

function log_install_start() {
  ascii_print "ğŸ“¦ Installing ${ASCII["reset"]}${ASCII["cyan"]}${1}" "yellow"
}

function install_linux_dependencies() {
  [[ ! $OSTYPE =~ ^linux.* ]] && return 0

  packages=(
    "fzf" # Fuzzy finder
    "libbz2-dev" # Python
    "libffi-dev" # Python
    "liblzma-dev" # Python
    "libreadline-dev" # Python
    "libsqlite3-dev" # Python
    "libssl-dev" # Python, Ruby
    "libterm-readkey-perl" # Git commit singlekey
    "libyaml-dev" # Ruby
    "make" # Ruby
    "ncdu" # Disk usage
    "neovim" # Neovim
    "ripgrep" # Ripgrep
    "shellcheck" # Shell formatting
    "tk-dev" # Python
    "zsh" # Shell
  )

  sudo apt-get update
  install_apt_packages "${packages[@]}"
}

install_linux_dependencies
configure_zsh
create_symlinks
install_mise
install_mise_tool "erlang" # Must install before elixir
install_mise_config
install_node_global_packages "prettier"
install_pgformatter
install_pip3_packages "black" "gnureadline"
install_ai_tools
init_git_submodules

ascii_print "ğŸ‰ Successfully installed Dev Tools!" "green"
ascii_print "Home rc files were updated so you may need to log out then back in for changes to take effect." "cyan"
